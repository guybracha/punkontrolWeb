// Firebase Security Rules להגנה על המסד נתונים
// העתק את הכללים האלה לקונסול Firebase -> Firestore Database -> Rules
// https://console.firebase.google.com/project/punkontrol/firestore/rules

rules_version = '2';
service cloud.firestore {
  match /databases/{db}/documents {

    /* ---------- פונקציות עזר ---------- */
    
    // המשתמש מחובר
    function signedIn() {
      return request.auth != null;
    }

    // המשתמש רשום במערכת ולא חסום
    function isKnown() {
      return signedIn() &&
        exists(/databases/$(db)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(db)/documents/users/$(request.auth.uid)).data.status != "blocked";
    }

    // בדיקה אם המשתמש רשאי לפרסם תוכן 18+
    function canPostAdult() {
      return get(/databases/$(db)/documents/users/$(request.auth.uid)).data.canPostAdult == true;
    }
    
    // בדיקה אם המשתמש הוא הבעלים
    function isOwner(userId) {
      return signedIn() && request.auth.uid == userId;
    }

    /* ---------- users ---------- */
    match /users/{uid} {
      // כולם יכולים לקרוא פרופילים ציבוריים
      allow read: if true;

      // רק המשתמש עצמו רשאי לערוך/לעדכן את הפרופיל שלו
      allow write: if isOwner(uid);
      
      // יצירה למשתמשים מחוברים
      allow create: if signedIn();
      
      // מחיקה רק על ידי בעל החשבון
      allow delete: if isOwner(uid);
    }

    /* ---------- artworks ---------- */
    match /artworks/{artworkId} {
      // כולם יכולים לקרוא יצירות ציבוריות
      allow read: if true;

      // יצירה חדשה: המשתמש חייב להיות רשום, הכותב הוא הוא עצמו
      // ואם מדובר בתוכן 18+, עליו להיות בעל הרשאה לכך
      allow create: if isKnown()
        && request.resource.data.authorId == request.auth.uid
        && (request.resource.data.ageRestricted != true || canPostAdult());

      // עדכון: רק יוצר היצירה יכול, ולא ניתן לשנות את authorId
      allow update: if signedIn()
        && request.auth.uid == resource.data.authorId
        && request.resource.data.authorId == resource.data.authorId;
      
      // מחיקה: רק יוצר היצירה יכול
      allow delete: if signedIn()
        && request.auth.uid == resource.data.authorId;
    }

    /* ---------- posts ---------- */
    match /posts/{postId} {
      // כולם יכולים לקרוא פוסטים
      allow read: if true;
      
      // יצירת פוסט: המשתמש חייב להיות רשום ומאומת
      allow create: if isKnown()
        && request.resource.data.authorId == request.auth.uid;
      
      // עדכון: רק יוצר הפוסט יכול, ולא ניתן לשנות את authorId
      allow update: if signedIn()
        && request.auth.uid == resource.data.authorId
        && request.resource.data.authorId == resource.data.authorId;
      
      // מחיקה: רק יוצר הפוסט יכול
      allow delete: if signedIn()
        && request.auth.uid == resource.data.authorId;
      
      // ========== תגובות (comments) ==========
      match /comments/{commentId} {
        // כולם יכולים לקרוא תגובות
        allow read: if true;
        
        // רק משתמשים מחוברים ומאומתים יכולים להוסיף תגובות
        allow create: if isKnown() 
          && request.resource.data.authorId == request.auth.uid;
        
        // עדכון תגובה על ידי כותב התגובה בלבד
        allow update: if signedIn() 
          && request.auth.uid == resource.data.authorId;
        
        // רק המחבר יכול למחוק את התגובה שלו
        allow delete: if signedIn() 
          && request.auth.uid == resource.data.authorId;
      }
      
      // ========== לייקים (likes) ==========
      match /likes/{userId} {
        // כולם יכולים לקרוא לייקים
        allow read: if true;
        
        // רק המשתמש יכול ליצור/למחוק לייק משלו
        allow create, delete: if signedIn() && request.auth.uid == userId;
      }
    }

    /* ---------- follows ---------- */
    match /follows/{fid} {
      // כולם יכולים לקרוא עוקבים
      allow read: if true;
      
      // רק המשתמש עצמו יכול ליצור/למחוק מעקב
      allow create, delete: if signedIn()
        && request.resource.data.followerId == request.auth.uid;
    }
  }
}
